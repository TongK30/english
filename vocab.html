<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard SRS</title>
    <style>
        :root {
            --primary: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --text: #2c3e50;
            --bg: #f4f6f7;
            --card-bg: #ffffff;
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .container { width: 100%; max-width: 500px; background: var(--card-bg); border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); padding: 30px; text-align: center; position: relative; }
        
        /* Cloze Styles */
        #cloze-container { display: flex; justify-content: center; gap: 5px; margin: 30px 0; flex-wrap: wrap; font-size: 2.2rem; font-weight: bold; }
        .cloze-input { width: 45px; height: 55px; font-size: 2rem; text-align: center; border: none; border-bottom: 4px solid var(--primary); background: #f0f8ff; color: var(--primary); outline: none; border-radius: 4px; font-weight: bold; text-transform: lowercase; }
        .cloze-input:focus { border-bottom-color: #2980b9; background: #eaf2f8; }
        .cloze-input.correct { border-bottom-color: var(--success); color: var(--success); background: #e8f8f5; }
        .cloze-input.wrong { border-bottom-color: var(--danger); color: var(--danger); background: #fdedec; }

        /* Modal Styles */
        #add-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        .input-group { display: flex; gap: 5px; margin-bottom: 10px; }
        .input-group input { margin-bottom: 0; flex: 1; }
        
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        button { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem; width: 100%; transition: 0.2s; }
        .btn-autofill { width: auto; background: var(--primary); color: white; padding: 0 15px; font-size: 1.2rem; }
        .btn-save { background: var(--success); color: white; margin-top: 10px; }
        .close-btn { background: #e74c3c; color: white; margin-top: 10px; }
        .open-add-btn { position: absolute; top: 15px; right: 15px; background: transparent; color: #bdc3c7; font-size: 2rem; width: auto; padding: 0; line-height: 1; }
        .open-add-btn:hover { color: var(--primary); }

        /* Feedback Area */
        #feedback-area { display: none; text-align: left; animation: fadeIn 0.5s; }
        .word-title { font-size: 2rem; color: var(--primary); font-weight: bold; }
        .ipa { color: #7f8c8d; font-style: italic; display: block; margin-bottom: 10px; }
        .meaning { font-size: 1.2rem; font-weight: bold; border-left: 4px solid var(--success); padding-left: 10px; margin-bottom: 10px; }
        .example-box { background: #f8f9fa; padding: 10px; border-radius: 8px; font-size: 0.95rem; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn-again { background: var(--danger); color: white; }
        .btn-good { background: var(--success); color: white; }
        .btn-reveal { background: #95a5a6; color: white; margin-top: 20px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
/* --- Style cho ƒê·ªìng nghƒ©a / Tr√°i nghƒ©a (Chips) --- */
.voc-group {
    margin-top: 12px;
    text-align: left;
}
.voc-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: #95a5a6;
    font-weight: bold;
    margin-bottom: 4px;
    display: block;
    letter-spacing: 0.5px;
}
.chip-container {
    display: flex;
    flex-wrap: wrap;
    gap: 6px; /* Kho·∫£ng c√°ch gi·ªØa c√°c t·ª´ */
}
.chip {
    padding: 4px 10px;
    border-radius: 15px; /* Bo tr√≤n nh∆∞ vi√™n thu·ªëc */
    font-size: 0.85rem;
    font-weight: 500;
    cursor: default;
    transition: transform 0.1s;
}
.chip:hover { transform: scale(1.05); }

/* M√†u Xanh cho ƒê·ªìng nghƒ©a (Synonyms) */
.chip-syn {
    background-color: #e8f5e9; /* N·ªÅn xanh nh·∫°t */
    color: #27ae60;           /* Ch·ªØ xanh ƒë·∫≠m */
    border: 1px solid #c8e6c9;
}

/* M√†u ƒê·ªè/Cam cho Tr√°i nghƒ©a (Antonyms) */
.chip-ant {
    background-color: #fdedec; /* N·ªÅn ƒë·ªè nh·∫°t */
    color: #c0392b;           /* Ch·ªØ ƒë·ªè ƒë·∫≠m */
    border: 1px solid #fadbd8;
}
/* Th√™m v√†o cu·ªëi ph·∫ßn style */
.card-image {
    width: 100%;
    height: 180px;
    object-fit: cover; /* ƒê·∫£m b·∫£o ·∫£nh kh√¥ng b·ªã m√©o */
    border-radius: 8px;
    margin-bottom: 15px;
    display: none; /* M·∫∑c ƒë·ªãnh ·∫©n, c√≥ ·∫£nh m·ªõi hi·ªán */
    border: 1px solid #eee;
}
/* N√∫t Micro */
#btn-mic {
    background-color: #f1c40f; /* M√†u v√†ng cam */
    color: #fff;
    font-size: 1.2rem;
    padding: 0 15px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
}

#btn-mic:hover {
    background-color: #f39c12;
}

/* Hi·ªáu ·ª©ng khi ƒëang thu √¢m (Class n√†y s·∫Ω ƒë∆∞·ª£c JS th√™m v√†o khi b·∫•m) */
.listening {
    background-color: #e74c3c !important; /* Chuy·ªÉn m√†u ƒë·ªè */
    animation: pulse 1.5s infinite;
}
/* Khung hi·ªÉn th·ªã k·∫øt qu·∫£ gi·ªçng n√≥i */
#voice-box {
    margin-top: 15px;
    padding: 10px;
    background-color: #fff3cd; /* M√†u v√†ng nh·∫°t */
    border: 1px solid #ffeeba;
    border-radius: 8px;
    animation: slideUp 0.3s ease-out;
}

#voice-result-text {
    font-size: 1.4rem; /* Ch·ªØ to r√µ */
    font-weight: bold;
    color: #333;
    margin-top: 5px;
}

@keyframes slideUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
    70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
}
/* --- C·∫§U H√åNH DARK MODE --- */

/* 1. ƒê·ªãnh nghƒ©a m√†u m·∫∑c ƒë·ªãnh (S√°ng) */
:root {
    --bg-body: #f4f7f6;       /* N·ªÅn trang */
    --bg-card: #ffffff;       /* N·ªÅn th·∫ª h·ªçc */
    --text-main: #333333;     /* Ch·ªØ ch√≠nh */
    --text-sub: #7f8c8d;      /* Ch·ªØ ph·ª• */
    --input-bg: #ffffff;      /* N·ªÅn √¥ nh·∫≠p li·ªáu */
    --border-color: #bdc3c7;  /* Vi·ªÅn */
    --voice-bg: #fff3cd;      /* N·ªÅn h·ªôp tho·∫°i voice */
    --voice-text: #856404;    /* Ch·ªØ h·ªôp tho·∫°i voice */
}

/* 2. ƒê·ªãnh nghƒ©a m√†u khi b·∫≠t Dark Mode (T·ªëi) */
body.dark-mode {
    --bg-body: #121212;       /* ƒêen s√¢u */
    --bg-card: #1e1e1e;       /* X√°m ƒëen */
    --text-main: #e0e0e0;     /* Tr·∫Øng x√°m */
    --text-sub: #b0b3b8;      /* X√°m nh·∫°t */
    --input-bg: #2d2d2d;      /* X√°m ƒë·∫≠m */
    --border-color: #404040;  /* Vi·ªÅn t·ªëi */
    --voice-bg: #2c3e50;      /* Xanh ƒëen (cho box voice) */
    --voice-text: #f1c40f;    /* V√†ng (cho ch·ªØ voice) */
}

/* 3. √Åp d·ª•ng bi·∫øn m√†u v√†o c√°c th√†nh ph·∫ßn */
body {
    background-color: var(--bg-body);
    color: var(--text-main);
    transition: background-color 0.3s, color 0.3s; /* Hi·ªáu ·ª©ng chuy·ªÉn m√†u m∆∞·ª£t */
}

.container, .modal-content {
    background-color: var(--bg-card) !important;
    color: var(--text-main);
    box-shadow: 0 4px 15px rgba(0,0,0,0.5); /* B√≥ng ƒë·ªï ƒë·∫≠m h∆°n cho n·ªïi */
}

/* Ch·ªânh m√†u √¥ nh·∫≠p li·ªáu */
input, .cloze-input {
    background-color: var(--input-bg);
    color: var(--text-main);
    border: 2px solid var(--border-color);
}

/* Ch·ªânh m√†u ch·ªØ ti√™u ƒë·ªÅ */
h1, h2, h3, .word-title {
    color: var(--text-main) !important;
}

/* Ch·ªânh ri√™ng cho c√°i Voice Box (m·ªõi l√†m l√∫c n√£y) */
#voice-box {
    background-color: var(--voice-bg) !important;
    border-color: var(--border-color) !important;
}
#voice-result-text {
    color: var(--text-main) !important; 
}
/* Ri√™ng ch·ªØ trong voice box n·∫øu ƒë√∫ng/sai th√¨ gi·ªØ nguy√™n m√†u xanh/ƒë·ªè c≈© */

/* Ch·ªânh modal th√™m/s·ª≠a */
#add-modal input, #edit-modal input {
    background-color: var(--input-bg);
    color: var(--text-main);
    border-color: var(--border-color);
}
    </style>
</head>
<body>
<button onclick="toggleDarkMode()" id="btn-theme" title="Ch·∫ø ƒë·ªô t·ªëi"
    style="position: fixed; top: 20px; right: 20px; background: transparent; border: none; font-size: 1.5rem; cursor: pointer; z-index: 100;">
    üåô
</button>
<div class="container">
    <button class="open-add-btn" onclick="openAddModal()" title="Th√™m t·ª´ m·ªõi">+</button>
    
    <h2 style="color:var(--primary); margin-top:0;">Flashcard SRS</h2>
    <div id="loading" style="color: #7f8c8d;">ƒêang t·∫£i d·ªØ li·ªáu...</div>

    <div id="study-area" style="display: none;">
        <div id="progress-text" style="font-size:0.9rem; color:#999; margin-bottom:10px;"></div>
        <div id="cloze-container"></div>
        <p style="font-size: 0.9rem; color:#999;">ƒêi·ªÅn k√Ω t·ª± c√≤n thi·∫øu</p>
       <button class="btn-reveal" onclick="revealAnswer()">Xem ƒë√°p √°n</button>
    <button id="btn-mic" onclick="startListening()" title="Luy·ªán n√≥i">üéôÔ∏è</button>
    <div id="voice-box" style="display: none;">
        <div style="font-size: 0.8rem; color: #7f8c8d; text-transform: uppercase;">M√°y nghe ƒë∆∞·ª£c:</div>
        <div id="voice-result-text">...</div>
    </div>
    
    <div id="mic-status" style="height: 20px; font-size: 0.85rem; color: #e67e22; margin-top: 5px;"></div>
   
    </div>

    <div id="feedback-area">
<img id="a-image" class="card-image" src="" alt="Minh h·ªça">
        <div style="display: flex; align-items: center; gap: 10px;">
    <div class="word-title" id="a-vocab"></div>
    <button onclick="playAudio(document.getElementById('a-vocab').innerText)" 
            style="width: 35px; height: 35px; border-radius: 50%; padding: 0; background: #eee; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;" 
            title="Nghe l·∫°i">
        üîä
    </button>
<button onclick="openEditModal()" title="Ch·ªânh s·ª≠a"
            style="width: 35px; height: 35px; border-radius: 50%; padding: 0; background: #fff3e0; color: #e67e22; border: 1px solid #ffe0b2; cursor: pointer;">
        ‚úèÔ∏è
    </button>
</div>
        <span class="ipa" id="a-ipa"></span>
        <div class="meaning" id="a-meaning"></div>
        <div class="example-box">
            <div id="a-example" style="font-weight: 500; color: #34495e;"></div>
            <div id="a-trans" style="color: #7f8c8d; margin-top: 4px; font-size: 0.9rem;"></div>
        </div>
        <div id="syn-ant-area" style="margin-top:10px; font-size:0.85rem;"></div>
        
        <p id="result-status" style="text-align: center; font-weight: bold; margin-top:15px;"></p>
        
        <div class="btn-group">
            <button class="btn-again" onclick="rateWord('again')">Qu√™n (H·ªçc l·∫°i)</button>
            <button class="btn-good" onclick="rateWord('good')">ƒê√£ nh·ªõ</button>
        </div>
    </div>

    <div id="done-msg" style="display: none;">
        <h3 style="color: var(--success);">üéâ Ho√†n th√†nh!</h3>
        <p>H·∫øt b√†i h√¥m nay.</p>
        <button onclick="location.reload()" style="background:var(--primary); color:white;">T·∫£i l·∫°i</button>
    </div>
</div>
<div id="duplicate-warning" style="color: #e74c3c; font-size: 0.9rem; margin-top: -8px; margin-bottom: 10px; display: none; font-weight: bold;">
    ‚ö†Ô∏è T·ª´ n√†y ƒë√£ c√≥ trong danh s√°ch!
</div>

<div id="add-modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color:var(--primary)">Th√™m t·ª´ m·ªõi</h3>
        
     <div class="input-group">
    <input type="text" id="f-vocab" placeholder="Nh·∫≠p ho·∫∑c d√°n t·ª´ v√†o ƒë√¢y..." autocomplete="off">
    <button class="btn-autofill" id="btn-lookup" onclick="autoFillWord()" title="T·ª± ƒë·ªông t√¨m">üîç</button>
</div>

<div id="duplicate-warning" style="color: #e74c3c; font-size: 0.9rem; margin-top: -8px; margin-bottom: 10px; display: none; font-weight: bold;">
    ‚ö†Ô∏è T·ª´ n√†y ƒë√£ c√≥ trong danh s√°ch!
</div>
        <p style="font-size: 0.8rem; color: #7f8c8d; margin-top:-5px; text-align: left;">B·∫•m k√≠nh l√∫p ƒë·ªÉ t·ª± ƒëi·ªÅn.</p>

        <input type="text" id="f-ipa" placeholder="IPA (Phi√™n √¢m)">
        <input type="text" id="f-meaning" placeholder="Nghƒ©a (Ti·∫øng Vi·ªát) *">
        <input type="text" id="f-example" placeholder="V√≠ d·ª• (Ti·∫øng Anh)">
        <input type="text" id="f-trans" placeholder="D·ªãch v√≠ d·ª•">
        <input type="text" id="f-syn" placeholder="ƒê·ªìng nghƒ©a">
        <input type="text" id="f-ant" placeholder="Tr√°i nghƒ©a">
        
        <button onclick="submitNewWord()" id="btn-save" class="btn-save">L∆∞u t·ª´ v·ª±ng</button>
        <button class="close-btn" onclick="closeAddModal()">ƒê√≥ng</button>
    </div>
</div>
<div id="edit-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center;">
    <div class="modal-content" style="border: 2px solid #f39c12;">
        <h3 style="margin-top:0; color:#e67e22">Ch·ªânh s·ª≠a t·ª´ v·ª±ng</h3>
        
        <input type="text" id="e-vocab" placeholder="T·ª´ v·ª±ng">
        <input type="text" id="e-ipa" placeholder="IPA">
        <input type="text" id="e-meaning" placeholder="Nghƒ©a">
        <input type="text" id="e-example" placeholder="V√≠ d·ª•">
        <input type="text" id="e-trans" placeholder="D·ªãch v√≠ d·ª•">
        <input type="text" id="e-syn" placeholder="ƒê·ªìng nghƒ©a">
        <input type="text" id="e-ant" placeholder="Tr√°i nghƒ©a">
        <input type="text" id="e-image" placeholder="Link ·∫£nh">
        
        <button onclick="submitEditWord()" id="btn-edit-save" style="background: #e67e22; color: white;">L∆∞u thay ƒë·ªïi</button>
        <button class="close-btn" onclick="document.getElementById('edit-modal').style.display='none'">H·ªßy</button>
    </div>
</div>
<script>
// --- BI·∫æN L∆ØU DANH S√ÅCH T·ª™ ƒê√É C√ì ---
    let existingWordsSet = new Set(); // D√πng Set ƒë·ªÉ t√¨m ki·∫øm si√™u nhanh

    // G·ªçi h√†m n√†y ngay khi window.onload ho·∫∑c c√πng l√∫c v·ªõi loadDueWords
    function loadExistingVocab() {
        fetch(API_URL + "?action=getAllVocab")
            .then(res => res.json())
            .then(data => {
                // Chuy·ªÉn h·∫øt v·ªÅ ch·ªØ th∆∞·ªùng ƒë·ªÉ so s√°nh ch√≠nh x√°c
                existingWordsSet = new Set(data.map(w => String(w).toLowerCase().trim()));
                console.log("ƒê√£ t·∫£i danh s√°ch ki·ªÉm tra tr√πng:", existingWordsSet.size, "t·ª´");
            })
            .catch(e => console.error("L·ªói t·∫£i danh s√°ch tr√πng:", e));
    }
    
    // S·ª≠a l·∫°i window.onload ƒë·ªÉ g·ªçi th√™m h√†m n√†y
    window.onload = function() {
        loadDueWords();
        loadExistingVocab(); // <--- G·ªçi th√™m ·ªü ƒë√¢y
    };
    // --- C·∫§U H√åNH API ---
    // Thay URL b√™n d∆∞·ªõi b·∫±ng Link App Script c·ªßa b·∫°n
    const API_URL = "https://script.google.com/macros/s/AKfycbyy-_qamv_xE6dnQExiz_JDybCsX8X8z7MDqjVqe_INre46w3mp8Eshh5sNrdORacZHmg/exec";

    let dueWords = [];
    let currentIndex = 0;
    let currentWord = null;
    let hiddenCharIndex = -1;
    let correctChar = "";
// H√†m ƒë∆∞·ª£c g·ªçi khi b·∫•m n√∫t Micro
    function startListening() {
        if (!recognition) {
            alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ (H√£y d√πng Chrome/Edge).");
            return;
        }
        // Reset tr·∫°ng th√°i
        document.getElementById('mic-status').innerText = "ƒêang nghe..."; 
        recognition.start();
    }
    // --- LOGIC H·ªåC T·∫¨P (CLOZE) ---
    window.onload = loadDueWords;

    function loadDueWords() {
        document.getElementById('loading').style.display = 'block';
        fetch(API_URL)
            .then(res => res.json())
            .then(data => {
                // S·∫Øp x·∫øp ng·∫´u nhi√™n
                dueWords = data.sort(() => Math.random() - 0.5);
                document.getElementById('loading').style.display = 'none';
                if (dueWords.length === 0) {
                    document.getElementById('done-msg').style.display = 'block';
                } else {
                    displayNextWord();
                }
            })
            .catch(e => {
                document.getElementById('loading').innerText = "L·ªói k·∫øt n·ªëi!";
                console.error(e);
            });
    }

    function displayNextWord() {
        if (currentIndex >= dueWords.length) {
            document.getElementById('study-area').style.display = 'none';
            document.getElementById('feedback-area').style.display = 'none';
            document.getElementById('done-msg').style.display = 'block';
            return;
        }
        currentWord = dueWords[currentIndex];
        document.getElementById('progress-text').innerText = `${currentIndex + 1} / ${dueWords.length}`;
        document.getElementById('study-area').style.display = 'block';
        document.getElementById('feedback-area').style.display = 'none';

        const container = document.getElementById('cloze-container');
        container.innerHTML = "";
        
        let vocab = currentWord.Vocabulary;
        // T√¨m v·ªã tr√≠ ƒë·ªÉ ·∫©n (∆∞u ti√™n ·∫©n nguy√™n √¢m ho·∫∑c random)
        let validIndices = [];
        for (let i = 0; i < vocab.length; i++) {
            if (/[a-zA-Z]/.test(vocab[i])) validIndices.push(i);
        }
        hiddenCharIndex = validIndices.length > 0 ? validIndices[Math.floor(Math.random() * validIndices.length)] : 0;
        correctChar = vocab[hiddenCharIndex].toLowerCase();

        for (let i = 0; i < vocab.length; i++) {
            if (i === hiddenCharIndex) {
                let input = document.createElement("input");
                input.className = "cloze-input";
                input.maxLength = 1;
                input.id = "cloze-box";
                input.autocomplete = "off";
                input.oninput = (e) => checkAnswer(e.target);
                container.appendChild(input);
            } else {
                let span = document.createElement("span");
                span.innerText = vocab[i];
                container.appendChild(span);
            }
        }
        setTimeout(() => document.getElementById('cloze-box')?.focus(), 100);
playAudio(currentWord.Vocabulary);
    }

    function checkAnswer(input) {
        if (input.value.toLowerCase() === correctChar) {
            input.classList.add("correct");
            input.disabled = true;
            setTimeout(() => showFeedback(true), 500);
        } else if (input.value.length > 0) {
            input.classList.add("wrong");
            setTimeout(() => { input.classList.remove("wrong"); input.value = ""; }, 500);
        }
    }

    function revealAnswer() { showFeedback(false); }

    function showFeedback(isCorrect) {
        document.getElementById('study-area').style.display = 'none';
        document.getElementById('feedback-area').style.display = 'block';
        
        // ƒêi·ªÅn d·ªØ li·ªáu
        document.getElementById('a-vocab').innerText = currentWord.Vocabulary;
        document.getElementById('a-ipa').innerText = currentWord.IPA ? `/${currentWord.IPA}/` : "";
        document.getElementById('a-meaning').innerText = currentWord.Meaning;
const imgEl = document.getElementById('a-image');
    if (currentWord.Image) {
        imgEl.src = currentWord.Image;
        imgEl.style.display = "block";
    } else {
        imgEl.style.display = "none";
    }
       // --- S·ª¨A ƒêO·∫†N HI·ªÇN TH·ªä V√ç D·ª§ ƒê·ªÇ C√ì LOA ---
        const exBox = document.getElementById('a-example');
        if (currentWord.Example) {
            // D√πng Flexbox ƒë·ªÉ x·∫øp c√°i loa n·∫±m ngang h√†ng v·ªõi c√¢u v√≠ d·ª•
            exBox.style.display = "flex";
            exBox.style.justifyContent = "space-between";
            exBox.style.alignItems = "flex-start";
            exBox.style.gap = "10px";

            exBox.innerHTML = `
                <span style="width:100%">${currentWord.Example}</span>
                <button onclick="playAudio(currentWord.Example)" 
                        title="Nghe v√≠ d·ª•"
                        style="background:none; border:none; cursor:pointer; font-size:1.2rem; min-width:30px; padding:0; color: var(--primary);">
                    üîä
                </button>
            `;
        } else {
            exBox.innerHTML = "";
            exBox.style.display = "block";
        }
        // -------------------------------------------
        document.getElementById('a-trans').innerText = currentWord.ExampleTrans;
        
       // --- ƒêO·∫†N CODE M·ªöI ƒê·ªÇ T·∫†O CHIPS M√ÄU S·∫ÆC ---
        const createChips = (str, type) => {
            if (!str) return "";
            // T√°ch chu·ªói b·∫±ng d·∫•u ph·∫©y v√† t·∫°o t·ª´ng th·∫ª span
            const chipsHtml = str.split(',').map(s => 
                `<span class="chip ${type}">${s.trim()}</span>`
            ).join('');
            
            const label = type === 'chip-syn' ? 'ƒê·ªìng nghƒ©a (Synonyms)' : 'Tr√°i nghƒ©a (Antonyms)';
            
            return `
                <div class="voc-group">
                    <span class="voc-label">${label}</span>
                    <div class="chip-container">${chipsHtml}</div>
                </div>
            `;
        };

        let finalHtml = "";
        // T·∫°o kh·ªëi ƒê·ªìng nghƒ©a (Xanh)
        if (currentWord.Synonyms) {
            finalHtml += createChips(currentWord.Synonyms, 'chip-syn');
        }
        // T·∫°o kh·ªëi Tr√°i nghƒ©a (ƒê·ªè)
        if (currentWord.Antonyms) {
            finalHtml += createChips(currentWord.Antonyms, 'chip-ant');
        }

        document.getElementById('syn-ant-area').innerHTML = finalHtml;
        // ---------------------------------------------

        const status = document.getElementById('result-status');
        if(isCorrect) {
            status.innerText = "CH√çNH X√ÅC!"; status.style.color = "var(--success)";
        } else {
            status.innerText = "ƒê√ÅP √ÅN: " + currentWord.Vocabulary; status.style.color = "var(--danger)";
        }
    }

    function rateWord(rating) {
        // G·ª≠i c·∫≠p nh·∫≠t v·ªÅ server (Fire and forget)
        fetch(API_URL, {
            method: "POST", mode: "no-cors", headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                action: "update",
                rowIndex: currentWord.rowIndex,
                rating: rating,
                currentInterval: currentWord.Interval
            })
        });
        currentIndex++;
        displayNextWord();
    }

    // --- LOGIC TH√äM T·ª™ (FRONTEND AUTOFILL) ---
    
    function openAddModal() { document.getElementById('add-modal').style.display = 'flex'; document.getElementById('f-vocab').focus(); }
    function closeAddModal() { document.getElementById('add-modal').style.display = 'none'; }

    // Helper hi·ªÉn th·ªã tr·∫°ng th√°i loading
    function showLoading(isLoading) {
        const btn = document.getElementById('btn-lookup');
        if(isLoading) {
            btn.innerText = "‚è≥";
            btn.disabled = true;
        } else {
            btn.innerText = "üîç";
            btn.disabled = false;
        }
    }

    // --- H√ÄM TRA T·ª™ C·ª¶A B·∫†N ---
    async function autoFillWord() {
        const word = document.getElementById('f-vocab').value.trim();
        if (!word) { alert("H√£y nh·∫≠p t·ª´ v·ª±ng!"); return; }

        showLoading(true);

        try {
            // 1. Dictionary API
            let dataDict = null;
            try {
                const resDict = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
                if (resDict.ok) {
                    const json = await resDict.json();
                    dataDict = json[0];
                }
            } catch (e) { console.log("Dict API error", e); }

            // 2. Google Translate Helper
            const translate = async (text) => {
                if(!text) return "";
                try {
                    const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=vi&dt=t&q=${encodeURIComponent(text)}`);
                    const json = await res.json();
                    return json[0].map(x => x[0]).join("");
                } catch (e) { return ""; }
            };

            // --- X·ª≠ l√Ω d·ªØ li·ªáu ---
            let ipa = "";
            let example = "";
            let synonyms = "";
            let antonyms = "";

            if (dataDict) {
                // IPA
                ipa = dataDict.phonetic || (dataDict.phonetics.find(p => p.text)?.text) || "";
                
                // Example & Syn/Ant (T√¨m s√¢u trong m·∫£ng)
                for (let m of dataDict.meanings) {
                    // Syn/Ant
                    if(!synonyms && m.synonyms && m.synonyms.length > 0) synonyms = m.synonyms.slice(0,5).join(", ");
                    if(!antonyms && m.antonyms && m.antonyms.length > 0) antonyms = m.antonyms.slice(0,5).join(", ");

                    // Example
                    for (let d of m.definitions) {
                        if (d.example) { example = d.example; break; }
                    }
                    if (example) break; 
                }
            }
const imageUrl = `https://loremflickr.com/400/300/${encodeURIComponent(word)}`;

            // D·ªãch
            const meaningVal = await translate(word);
            const exampleTransVal = await translate(example);

            // ƒêi·ªÅn form (L∆∞u √Ω ID ƒë√£ ƒë∆∞·ª£c ƒë·ªïi sang f-...)
            document.getElementById('f-ipa').value = ipa;
            document.getElementById('f-meaning').value = meaningVal;
            document.getElementById('f-example').value = example;
            document.getElementById('f-trans').value = exampleTransVal;
            document.getElementById('f-syn').value = synonyms;
            document.getElementById('f-ant').value = antonyms;
document.getElementById('f-image').value = imageUrl;
        // Hi·ªán preview nh·ªè b√™n c·∫°nh (Optional)
        const preview = document.getElementById('preview-img');
        preview.src = imageUrl;
        preview.style.display = "block";
        } catch (err) {
            console.error(err);
            alert("L·ªói khi t√¨m ki·∫øm.");
        } finally {
            showLoading(false);
        }
    }

    function submitNewWord() {
        const vocab = document.getElementById('f-vocab').value;
        const meaning = document.getElementById('f-meaning').value;

        if(!vocab || !meaning) return alert("C·∫ßn nh·∫≠p T·ª´ v·ª±ng v√† Nghƒ©a!");

        const btn = document.getElementById('btn-save');
        btn.innerText = "ƒêang l∆∞u..."; btn.disabled = true;

        const newWord = {
            action: "add",
            Vocabulary: vocab,
            IPA: document.getElementById('f-ipa').value,
            Meaning: meaning,
            Example: document.getElementById('f-example').value,
            ExampleTrans: document.getElementById('f-trans').value,
            Synonyms: document.getElementById('f-syn').value,
            Antonyms: document.getElementById('f-ant').value,
Image: document.getElementById('f-image').value
        };

        fetch(API_URL, {
            method: "POST", mode: "no-cors", headers: {"Content-Type": "application/json"},
            body: JSON.stringify(newWord)
        }).then(() => {
            alert("ƒê√£ th√™m th√†nh c√¥ng!");
existingWordsSet.add(vocab.toLowerCase().trim());
            closeAddModal();
            // Reset form
            document.querySelectorAll('#add-modal input').forEach(i => i.value = '');
            btn.innerText = "L∆∞u t·ª´ v·ª±ng"; btn.disabled = false;
        }).catch(e => {
            alert("L·ªói l∆∞u: " + e);
            btn.innerText = "L∆∞u t·ª´ v·ª±ng"; btn.disabled = false;
        });
    }
// --- T·ª∞ ƒê·ªòNG T√åM KHI NH·∫¨P T·ª™ (AUTO TRIGGER) ---
    let typingTimer;                // Bi·∫øn ƒë·∫øm th·ªùi gian
    const doneTypingInterval = 800; // Th·ªùi gian ch·ªù (0.8 gi√¢y)
    const inputVocab = document.getElementById('f-vocab');

    // 1. Khi ng∆∞·ªùi d√πng g√µ ph√≠m
   // --- S·ª¨A L·∫†I ƒêO·∫†N S·ª∞ KI·ªÜN INPUT ---
    inputVocab.addEventListener('input', () => {
        const val = inputVocab.value.trim().toLowerCase();
        const warning = document.getElementById('duplicate-warning');
        const btnSave = document.getElementById('btn-save');

        // 1. Ki·ªÉm tra tr√πng
        if (existingWordsSet.has(val)) {
            warning.style.display = 'block'; // Hi·ªán c·∫£nh b√°o
            btnSave.disabled = true;         // Kh√≥a n√∫t l∆∞u
            btnSave.style.opacity = "0.5";
            clearTimeout(typingTimer);       // N·∫øu tr√πng th√¨ kh√¥ng c·∫ßn t·ª± ƒë·ªông t√¨m l√†m g√¨
            return; 
        } else {
            warning.style.display = 'none';  // ·∫®n c·∫£nh b√°o
            btnSave.disabled = false;        // M·ªü n√∫t l∆∞u
            btnSave.style.opacity = "1";
        }

        // 2. Logic Debounce c≈© (T·ª± ƒë·ªông t√¨m ki·∫øm)
        clearTimeout(typingTimer);
        if (inputVocab.value.trim()) {
            typingTimer = setTimeout(autoFillWord, doneTypingInterval);
        }
    });

    // 2. Khi ng∆∞·ªùi d√πng Paste (d√°n) t·ª´ v√†o -> T√¨m ngay l·∫≠p t·ª©c
    inputVocab.addEventListener('paste', () => {
        clearTimeout(typingTimer);
        // Ch·ªù 1 x√≠u (100ms) ƒë·ªÉ d·ªØ li·ªáu k·ªãp d√°n v√†o √¥ input r·ªìi t√¨m lu√¥n
        setTimeout(autoFillWord, 100);
    });
// --- H√ÄM PH√ÅT √ÇM THANH ---
    function playAudio(text) {
        if (!text) return;
        // S·ª≠ d·ª•ng API ƒë·ªçc c·ªßa Google Translate
        const url = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=en&q=${encodeURIComponent(text)}`;
        const audio = new Audio(url);
        audio.play().catch(e => console.log("Ch·∫∑n t·ª± ƒë·ªông ph√°t: c·∫ßn t∆∞∆°ng t√°c ng∆∞·ªùi d√πng"));
    }
// --- CH·ª®C NƒÇNG LUY·ªÜN N√ìI (SPEECH TO TEXT) - ƒê√É S·ª¨A L·ªñI ---
    
    // 1. Khai b√°o bi·∫øn TO√ÄN C·ª§C (ƒë·ªÉ h√†m n√†o c≈©ng g·ªçi ƒë∆∞·ª£c)
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition; 

    // 2. Thi·∫øt l·∫≠p c·∫•u h√¨nh ngay khi ch·∫°y web
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = 'en-US'; 
        recognition.interimResults = false; 
        recognition.maxAlternatives = 1;

       
        // Khi b·∫Øt ƒë·∫ßu n√≥i th√¨ ·∫©n k·∫øt qu·∫£ c≈© ƒëi cho g·ªçn
        recognition.onstart = () => {
            document.getElementById('btn-mic').classList.add('listening');
            document.getElementById('mic-status').innerText = "ƒêang nghe...";
            document.getElementById('voice-box').style.display = 'none'; // ·∫®n k·∫øt qu·∫£ c≈©
        };

        // Khi k·∫øt th√∫c
        recognition.onend = () => {
            const btn = document.getElementById('btn-mic');
            if(btn) btn.classList.remove('listening');
            
            const status = document.getElementById('mic-status');
            if(status) status.innerText = "";
        };

        // X·ª≠ l√Ω k·∫øt qu·∫£ tr·∫£ v·ªÅ
        // KHI C√ì K·∫æT QU·∫¢ TR·∫¢ V·ªÄ (ƒê√£ s·ª≠a l·ªói checkAnswer)
       // KHI C√ì K·∫æT QU·∫¢ TR·∫¢ V·ªÄ (Phi√™n b·∫£n t√°ch ri√™ng hi·ªÉn th·ªã)
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript.toLowerCase().trim();
            const correctWord = currentWord.Vocabulary.toLowerCase().trim();
            
            // 1. Hi·ªÉn th·ªã khung k·∫øt qu·∫£ gi·ªçng n√≥i ra
            const voiceBox = document.getElementById('voice-box');
            const voiceText = document.getElementById('voice-result-text');
            const statusEl = document.getElementById('mic-status');
            
            voiceBox.style.display = 'block'; // Hi·ªán khung
            voiceText.innerText = transcript; // In t·ª´ b·∫°n n√≥i ra

            // 2. So s√°nh logic
            const cleanTranscript = transcript.replace(/[^a-z0-9]/g, "");
            const cleanCorrect = correctWord.replace(/[^a-z0-9]/g, "");

            if (cleanTranscript === cleanCorrect && cleanCorrect.length > 0) {
                // --- N·∫æU ƒê√öNG ---
                voiceText.style.color = "#27ae60"; // Ch·ªØ m√†u xanh l√°
                statusEl.innerText = "Ch√≠nh x√°c! üéâ";
                
                // T·ª± ƒë·ªông ƒëi·ªÅn v√†o c√°c √¥ tr·ªëng ·ªü tr√™n (Feedback h√¨nh ·∫£nh)
                const inputs = document.querySelectorAll('.cloze-input');
                const originalWord = currentWord.Vocabulary;
                inputs.forEach((input, index) => {
                    if(originalWord[index]) input.value = originalWord[index];
                    input.classList.add('correct');
                    input.disabled = true;
                });

                // Chuy·ªÉn b√†i sau 1 gi√¢y
                setTimeout(() => showFeedback(true), 1000);

            } else {
                // --- N·∫æU SAI ---
                voiceText.style.color = "#c0392b"; // Ch·ªØ m√†u ƒë·ªè
                statusEl.innerText = "Ch∆∞a ƒë√∫ng, th·ª≠ l·∫°i nh√©!";
                
                // Rung l·∫Øc khung gi·ªçng n√≥i
                voiceBox.classList.add('shake');
                setTimeout(() => voiceBox.classList.remove('shake'), 500);
            }
        };

       
        
        recognition.onerror = (event) => {
            const status = document.getElementById('mic-status');
            if(status) status.innerText = "L·ªói: " + event.error;
            const btn = document.getElementById('btn-mic');
            if(btn) btn.classList.remove('listening');
        };

    } else {
        console.log("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Speech API");
        const btn = document.getElementById('btn-mic');
        if(btn) btn.style.display = 'none';
    }

    // 3. H√†m k√≠ch ho·∫°t (g·∫Øn v√†o n√∫t b·∫•m)
    function startListening() {
        if (!recognition) {
            alert("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ch·ª©c nƒÉng n√†y. H√£y d√πng Google Chrome ho·∫∑c Edge.");
            return;
        }
        try {
            recognition.start();
        } catch (e) {
            console.error(e);
            // N·∫øu l·ªói do ƒëang ch·∫°y r·ªìi m√† b·∫•m ti·∫øp th√¨ t·∫Øt ƒëi b·∫≠t l·∫°i
            recognition.stop();
        }
    }
// --- CH·ª®C NƒÇNG CH·ªàNH S·ª¨A T·ª™ ---

    function openEditModal() {
        if (!currentWord) return;

        // 1. ƒêi·ªÅn d·ªØ li·ªáu c≈© v√†o form
        document.getElementById('e-vocab').value = currentWord.Vocabulary;
        document.getElementById('e-ipa').value = currentWord.IPA;
        document.getElementById('e-meaning').value = currentWord.Meaning;
        document.getElementById('e-example').value = currentWord.Example;
        document.getElementById('e-trans').value = currentWord.ExampleTrans;
        document.getElementById('e-syn').value = currentWord.Synonyms;
        document.getElementById('e-ant').value = currentWord.Antonyms;
        document.getElementById('e-image').value = currentWord.Image;

        // 2. Hi·ªán Modal
        document.getElementById('edit-modal').style.display = 'flex';
    }

    function submitEditWord() {
        const btn = document.getElementById('btn-edit-save');
        btn.innerText = "ƒêang l∆∞u..."; btn.disabled = true;

        // L·∫•y d·ªØ li·ªáu m·ªõi t·ª´ form
        const updatedData = {
            action: "edit_content",
            rowIndex: currentWord.rowIndex, // R·∫•t quan tr·ªçng: G·ª≠i s·ªë d√≤ng ƒë·ªÉ bi·∫øt s·ª≠a d√≤ng n√†o
            Vocabulary: document.getElementById('e-vocab').value,
            IPA: document.getElementById('e-ipa').value,
            Meaning: document.getElementById('e-meaning').value,
            Example: document.getElementById('e-example').value,
            ExampleTrans: document.getElementById('e-trans').value,
            Synonyms: document.getElementById('e-syn').value,
            Antonyms: document.getElementById('e-ant').value,
            Image: document.getElementById('e-image').value
        };

        fetch(API_URL, {
            method: "POST", mode: "no-cors", headers: {"Content-Type": "application/json"},
            body: JSON.stringify(updatedData)
        }).then(() => {
            alert("ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!");
            document.getElementById('edit-modal').style.display = 'none';
            btn.innerText = "L∆∞u thay ƒë·ªïi"; btn.disabled = false;

            // --- C·∫¨P NH·∫¨T GIAO DI·ªÜN NGAY L·∫¨P T·ª®C (KH√îNG C·∫¶N F5) ---
            // G√°n d·ªØ li·ªáu m·ªõi v√†o bi·∫øn currentWord
            currentWord.Vocabulary = updatedData.Vocabulary;
            currentWord.IPA = updatedData.IPA;
            currentWord.Meaning = updatedData.Meaning;
            currentWord.Example = updatedData.Example;
            currentWord.ExampleTrans = updatedData.ExampleTrans;
            currentWord.Synonyms = updatedData.Synonyms;
            currentWord.Antonyms = updatedData.Antonyms;
            currentWord.Image = updatedData.Image;

            // V·∫Ω l·∫°i giao di·ªán k·∫øt qu·∫£
            showFeedback(true); 

        }).catch(e => {
            alert("L·ªói: " + e);
            btn.innerText = "L∆∞u thay ƒë·ªïi"; btn.disabled = false;
        });
    }
// --- CH·ª®C NƒÇNG DARK MODE ---

    // 1. Ki·ªÉm tra xem ng∆∞·ªùi d√πng ƒë√£ ch·ªçn Dark Mode tr∆∞·ªõc ƒë√≥ ch∆∞a
    if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
        document.getElementById('btn-theme').innerText = '‚òÄÔ∏è'; // ƒê·ªïi icon th√†nh m·∫∑t tr·ªùi
    }

    // 2. H√†m chuy·ªÉn ƒë·ªïi
    function toggleDarkMode() {
        const body = document.body;
        const btn = document.getElementById('btn-theme');
        
        // B·∫≠t/t·∫Øt class
        body.classList.toggle('dark-mode');

        // Ki·ªÉm tra xem hi·ªán t·∫°i ƒëang l√† mode n√†o ƒë·ªÉ l∆∞u v√† ƒë·ªïi icon
        if (body.classList.contains('dark-mode')) {
            localStorage.setItem('theme', 'dark'); // L∆∞u l·∫°i "ƒë√¢y l√† dark"
            btn.innerText = '‚òÄÔ∏è'; // Hi·ªán m·∫∑t tr·ªùi (ƒë·ªÉ b·∫•m v√†o th√¨ s√°ng l·∫°i)
        } else {
            localStorage.setItem('theme', 'light'); // L∆∞u l·∫°i "ƒë√¢y l√† light"
            btn.innerText = 'üåô'; // Hi·ªán m·∫∑t trƒÉng
        }
    }
</script>

</body>
</html>
