<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard SRS - Pro Fixed</title>
    <style>
        :root {
            --primary: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --text: #2c3e50;
            --bg: #f4f6f7;
            --card-bg: #ffffff;
            
            /* Dark Mode Variables */
            --bg-body: #f4f7f6;
            --bg-card: #ffffff;
            --text-main: #333333;
            --text-sub: #7f8c8d;
            --input-bg: #ffffff;
            --border-color: #bdc3c7;
            --voice-bg: #fff3cd;
        }

        body.dark-mode {
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #b0b3b8;
            --input-bg: #2d2d2d;
            --border-color: #404040;
            --voice-bg: #2c3e50;
        }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            display: flex; justify-content: center; align-items: center; 
            min-height: 100vh; margin: 0; padding: 20px; 
            transition: background-color 0.3s, color 0.3s;
        }

        .container { 
            width: 100%; max-width: 500px; 
            background: var(--bg-card); 
            border-radius: 15px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            padding: 30px; text-align: center; position: relative; 
            border: 1px solid var(--border-color);
        }
        
        /* --- FIXED: N√∫t Add (+) --- */
        .open-add-btn { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            background: transparent; 
            color: #bdc3c7; 
            font-size: 2.2rem; /* To h∆°n ch√∫t ƒë·ªÉ d·ªÖ b·∫•m */
            width: 40px; 
            height: 40px; 
            padding: 0; 
            line-height: 35px; /* CƒÉn gi·ªØa d·∫•u c·ªông */
            cursor: pointer;
            z-index: 50; /* ƒê·∫£m b·∫£o n·ªïi l√™n tr√™n */
            border-radius: 50%;
            transition: 0.2s;
        }
        .open-add-btn:hover { 
            color: var(--primary); 
            background-color: rgba(0,0,0,0.05);
        }

        /* --- FIXED: N√∫t Dark Mode (Chuy·ªÉn sang tr√°i) --- */
        #btn-theme {
            position: fixed; 
            top: 15px; 
            left: 15px; /* Chuy·ªÉn sang tr√°i */
            background: rgba(0,0,0,0.1); /* N·ªÅn m·ªù nh·∫π */
            border: none; 
            font-size: 1.2rem; /* Nh·ªè l·∫°i */
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer; 
            z-index: 100;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(2px);
        }

        /* --- TAG FILTER & SEARCH --- */
        .controls-row { display: flex; gap: 10px; margin-bottom: 20px; margin-top: 10px; }
        
        .search-container { position: relative; flex: 2; }
        .search-box {
            width: 100%; padding: 10px 15px 10px 35px; margin: 0;
            border-radius: 20px; border: 1px solid var(--border-color);
            background: var(--input-bg); color: var(--text-main);
            outline: none; transition: 0.3s;
        }
        .search-box:focus { border-color: var(--primary); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-sub); font-size: 0.9rem;}
        
        .tag-filter-select {
            flex: 1; padding: 0 10px; border-radius: 20px;
            border: 1px solid var(--border-color);
            background: var(--input-bg); color: var(--text-main);
            font-weight: bold; cursor: pointer;
            max-width: 150px;
        }

        .search-results {
            position: absolute; top: 110%; left: 0; width: 100%;
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-height: 250px; overflow-y: auto; z-index: 200; /* TƒÉng z-index ƒë·ªÉ kh√¥ng b·ªã che */
            display: none; text-align: left;
        }
        .search-item {
            padding: 10px 15px; border-bottom: 1px solid var(--border-color);
            cursor: pointer; display: flex; justify-content: space-between;
        }
        .search-item:hover { background-color: rgba(0,0,0,0.05); }

        /* Cloze Styles */
        #cloze-container { display: flex; justify-content: center; gap: 5px; margin: 30px 0; flex-wrap: wrap; font-size: 2.2rem; font-weight: bold; }
        .cloze-input { 
            width: 45px; height: 55px; font-size: 2rem; text-align: center; 
            border: none; border-bottom: 4px solid var(--primary); 
            background: var(--input-bg); color: var(--text-main); 
            outline: none; border-radius: 4px; font-weight: bold; text-transform: lowercase; 
        }
        .cloze-input:focus { border-bottom-color: #2980b9; background: rgba(52, 152, 219, 0.1); }
        .cloze-input.correct { border-bottom-color: var(--success); color: var(--success); background: rgba(46, 204, 113, 0.1); }
        .cloze-input.wrong { border-bottom-color: var(--danger); color: var(--danger); background: rgba(231, 76, 60, 0.1); }

        /* General UI */
        input, textarea, select { 
            width: 100%; padding: 12px; margin-bottom: 10px; 
            border: 1px solid var(--border-color); border-radius: 6px; 
            box-sizing: border-box; font-size: 1rem; 
            background: var(--input-bg); color: var(--text-main);
        }
        button { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem; width: 100%; transition: 0.2s; }
        
        /* Feedback Area */
        #feedback-area { display: none; text-align: left; animation: fadeIn 0.5s; }
        .word-title { font-size: 2rem; color: var(--primary); font-weight: bold; }
        .ipa { color: var(--text-sub); font-style: italic; display: block; margin-bottom: 10px; }
        .meaning { font-size: 1.2rem; font-weight: bold; border-left: 4px solid var(--success); padding-left: 10px; margin-bottom: 10px; color: var(--text-main); }
        .example-box { background: rgba(0,0,0,0.05); padding: 10px; border-radius: 8px; font-size: 0.95rem; color: var(--text-main); }
        
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn-again { background: var(--danger); color: white; }
        .btn-good { background: var(--success); color: white; }
        .btn-reveal { background: #95a5a6; color: white; margin-top: 20px; }
        
        .tag-badge { display: inline-block; background: #9b59b6; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Chips for Synonyms/Antonyms */
        .voc-group { margin-top: 12px; text-align: left; }
        .voc-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-sub); font-weight: bold; margin-bottom: 4px; display: block; letter-spacing: 0.5px; }
        .chip-container { display: flex; flex-wrap: wrap; gap: 6px; }
        .chip { padding: 4px 10px; border-radius: 15px; font-size: 0.85rem; font-weight: 500; cursor: default; transition: transform 0.1s; }
        .chip-syn { background-color: rgba(46, 204, 113, 0.15); color: #27ae60; border: 1px solid rgba(46, 204, 113, 0.3); }
        .chip-ant { background-color: rgba(231, 76, 60, 0.15); color: #c0392b; border: 1px solid rgba(231, 76, 60, 0.3); }

        .card-image { width: 100%; height: 180px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; display: none; border: 1px solid var(--border-color); }

        /* Microphone & Voice */
        #btn-mic { background-color: #f1c40f; color: #fff; font-size: 1.2rem; padding: 0 15px; border: none; cursor: pointer; width: auto; display: inline-block; margin-top: 10px; }
        #btn-mic:hover { background-color: #f39c12; }
        .listening { background-color: #e74c3c !important; animation: pulse 1.5s infinite; }
        #voice-box { margin-top: 15px; padding: 10px; background-color: var(--voice-bg); border: 1px solid var(--border-color); border-radius: 8px; animation: slideUp 0.3s ease-out; }
        #voice-result-text { font-size: 1.4rem; font-weight: bold; color: var(--text-main); margin-top: 5px; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }

        /* --- MODAL ADD NEW (PRO STYLE) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-box-pro { background: var(--bg-card); width: 900px; max-width: 95%; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); border: 1px solid var(--border-color); overflow: hidden; display: flex; flex-direction: column; animation: zoomIn 0.2s ease-out; }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; }}

        .modal-header { background: linear-gradient(135deg, var(--primary), #2980b9); padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; color: white !important; font-size: 1.2rem; }
        .close-icon { color: white; font-size: 2rem; cursor: pointer; line-height: 0.7; opacity: 0.8; }
        .close-icon:hover { opacity: 1; }

        .modal-body-grid { padding: 25px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .form-group { margin-bottom: 12px; display: flex; flex-direction: column; }
        .form-group label { font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.5px; }
        .input-wrapper { display: flex; gap: 5px; }
        .input-wrapper input { flex: 1; font-weight: bold; font-size: 1.1rem; }
        #btn-lookup { width: 45px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        #btn-lookup:hover { background: #2980b9; }

        .image-input-group { display: flex; gap: 10px; align-items: center; }
        .image-input-group input { flex: 1; }
        #preview-img { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid var(--border-color); display: none; }

        .form-row { display: flex; gap: 15px; }
        .form-row .form-group { flex: 1; }
        .hint-text { font-size: 0.75rem; color: var(--text-sub); margin-top: 4px; font-style: italic; }
        .warning-text { color: var(--danger); font-size: 0.85rem; font-weight: bold; margin-top: 5px; display: none; }

        .modal-footer { padding: 15px 25px; background: rgba(0,0,0,0.03); border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px; }
        .btn-cancel { background: transparent; border: 1px solid var(--border-color); color: var(--text-sub); width: auto; padding: 10px 20px; }
        .btn-submit { background: var(--success); color: white; width: auto; padding: 10px 25px; box-shadow: 0 2px 5px rgba(46, 204, 113, 0.3); }
        .btn-bulk { background: #9b59b6; color: white; width: auto; padding: 10px 20px; margin-right: auto; }

        /* --- BULK IMPORT MODAL --- */
        #bulk-textarea { font-family: monospace; font-size: 0.9rem; white-space: pre; overflow-x: auto; }
        .bulk-guide { background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; font-size: 0.85rem; margin-bottom: 10px; border: 1px solid #ffeeba; }

        @media (max-width: 768px) {
            .modal-body-grid { grid-template-columns: 1fr; gap: 15px; padding: 15px; }
            .modal-box-pro { height: 90vh; overflow-y: auto; }
            .form-row { flex-direction: column; gap: 0; }
        }
    </style>
</head>
<body>

<button onclick="toggleDarkMode()" id="btn-theme" title="Ch·∫ø ƒë·ªô t·ªëi">
    üåô
</button>

<div class="container">
    <button class="open-add-btn" onclick="openAddModal()" title="Th√™m t·ª´ m·ªõi">+</button>
    
    <h2 style="color:var(--primary); margin-top:0;">Flashcard SRS</h2>
    
    <div class="controls-row">
        <div class="search-container">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-box" id="main-search" placeholder="T√¨m ki·∫øm..." autocomplete="off">
            <div class="search-results" id="search-results-box"></div>
        </div>
        
        <select id="tag-filter" class="tag-filter-select" onchange="applyFilter()" title="L·ªçc theo ch·ªß ƒë·ªÅ">
            <option value="all">üìö T·∫•t c·∫£</option>
            </select>
    </div>

    <div id="loading" style="color: #7f8c8d;">ƒêang t·∫£i d·ªØ li·ªáu...</div>

    <div id="study-area" style="display: none;">
        <div id="progress-text" style="font-size:0.9rem; color:#999; margin-bottom:10px;"></div>
        <div id="cloze-container"></div>
        <p style="font-size: 0.9rem; color:#999;">ƒêi·ªÅn k√Ω t·ª± c√≤n thi·∫øu</p>
        
        <button class="btn-reveal" onclick="revealAnswer()">Xem ƒë√°p √°n</button>
        
        <div style="text-align: center;">
             <button id="btn-mic" onclick="startListening()" title="Luy·ªán n√≥i">üéôÔ∏è</button>
             <div id="mic-status" style="height: 20px; font-size: 0.85rem; color: #e67e22; margin-top: 5px;"></div>
        </div>
       
        <div id="voice-box" style="display: none;">
            <div style="font-size: 0.8rem; color: #7f8c8d; text-transform: uppercase;">M√°y nghe ƒë∆∞·ª£c:</div>
            <div id="voice-result-text">...</div>
        </div>
    </div>

    <div id="feedback-area">
        <div id="a-tag-badge" style="text-align: center;"></div>
        <img id="a-image" class="card-image" src="" alt="Minh h·ªça">
        <div style="display: flex; align-items: center; gap: 10px; justify-content: center;">
            <div class="word-title" id="a-vocab"></div>
            <button onclick="playAudio(document.getElementById('a-vocab').innerText)" 
                    style="width: 35px; height: 35px; border-radius: 50%; padding: 0; background: #eee; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; width:auto;" 
                    title="Nghe l·∫°i">
                üîä
            </button>
            <button onclick="openEditModalFromView()" title="Ch·ªânh s·ª≠a"
                    style="width: 35px; height: 35px; border-radius: 50%; padding: 0; background: #fff3e0; color: #e67e22; border: 1px solid #ffe0b2; cursor: pointer; width:auto;">
                ‚úèÔ∏è
            </button>
        </div>
        <span class="ipa" id="a-ipa"></span>
        <div class="meaning" id="a-meaning"></div>
        <div class="example-box">
            <div id="a-example" style="font-weight: 500; color: #34495e;"></div>
            <div id="a-trans" style="color: #7f8c8d; margin-top: 4px; font-size: 0.9rem;"></div>
        </div>
        <div id="syn-ant-area" style="margin-top:10px; font-size:0.85rem;"></div>
        
        <p id="result-status" style="text-align: center; font-weight: bold; margin-top:15px;"></p>
        
        <div class="btn-group">
            <button class="btn-again" onclick="rateWord('again')">Qu√™n (H·ªçc l·∫°i)</button>
            <button class="btn-good" onclick="rateWord('good')">ƒê√£ nh·ªõ</button>
        </div>
    </div>

    <div id="done-msg" style="display: none;">
        <h3 style="color: var(--success);">üéâ Ho√†n th√†nh!</h3>
        <p>H·∫øt b√†i thu·ªôc ch·ªß ƒë·ªÅ n√†y.</p>
        <button onclick="location.reload()" style="background:var(--primary); color:white;">T·∫£i l·∫°i t·∫•t c·∫£</button>
    </div>
</div>

<div id="add-modal" class="modal-overlay">
    <div class="modal-box-pro">
        <div class="modal-header">
            <h3>‚ú® Th√™m th·∫ª m·ªõi</h3>
            <span class="close-icon" onclick="closeAddModal()">&times;</span>
        </div>

        <div class="modal-body-grid">
            <div class="grid-col left-col">
                <div class="form-group">
                    <label>T·ª´ v·ª±ng <span style="color:var(--danger)">*</span></label>
                    <div class="input-wrapper">
                        <input type="text" id="f-vocab" placeholder="Nh·∫≠p t·ª´..." autocomplete="off">
                        <button id="btn-lookup" onclick="autoFillWord()" title="T·ª± ƒë·ªông t√¨m (Auto-fill)">üîç</button>
                    </div>
                    <div id="duplicate-warning" class="warning-text">‚ö†Ô∏è T·ª´ n√†y ƒë√£ c√≥ trong danh s√°ch!</div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Phi√™n √¢m (IPA)</label>
                        <input type="text" id="f-ipa" placeholder="/.../">
                    </div>
                    <div class="form-group">
                        <label>Ch·ªß ƒë·ªÅ (Tag)</label>
                        <input type="text" id="f-tag" list="tag-suggestions" placeholder="VD: IT, IELTS">
                        <datalist id="tag-suggestions"></datalist>
                    </div>
                </div>

                <div class="form-group">
                    <label>Nghƒ©a Ti·∫øng Vi·ªát <span style="color:var(--danger)">*</span></label>
                    <input type="text" id="f-meaning" placeholder="Nghƒ©a c·ªßa t·ª´...">
                </div>

                <div class="form-group">
                    <label>H√¨nh ·∫£nh (URL)</label>
                    <div class="image-input-group">
                        <input type="text" id="f-image" placeholder="https://...">
                        <img id="preview-img" src="" alt="Preview">
                    </div>
                </div>
            </div>

            <div class="grid-col right-col">
                <div class="form-group">
                    <label>C√¢u v√≠ d·ª•</label>
                    <textarea id="f-example" rows="2" placeholder="V√≠ d·ª• s·ª≠ d·ª•ng t·ª´ n√†y..."></textarea>
                </div>

                <div class="form-group">
                    <label>D·ªãch v√≠ d·ª•</label>
                    <textarea id="f-trans" rows="2" placeholder="D·ªãch nghƒ©a c√¢u v√≠ d·ª•..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ƒê·ªìng nghƒ©a</label>
                        <input type="text" id="f-syn" placeholder="Synonyms...">
                    </div>
                    <div class="form-group">
                        <label>Tr√°i nghƒ©a</label>
                        <input type="text" id="f-ant" placeholder="Antonyms...">
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-bulk" onclick="openBulkModal()" title="Nh·∫≠p nhi·ªÅu t·ª´ c√πng l√∫c">üì• Import Nhanh</button>
            <button class="btn-cancel" onclick="closeAddModal()">H·ªßy b·ªè</button>
            <button class="btn-submit" id="btn-save" onclick="submitNewWord()">L∆∞u th·∫ª n√†y</button>
        </div>
    </div>
</div>

<div id="bulk-modal" class="modal-overlay">
    <div class="modal-box-pro" style="width: 600px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
            <h3>üì• Import Nhi·ªÅu T·ª´</h3>
            <span class="close-icon" onclick="document.getElementById('bulk-modal').style.display='none'">&times;</span>
        </div>
        <div class="modal-body-grid" style="grid-template-columns: 1fr;">
            <div class="bulk-guide">
                <strong>H∆∞·ªõng d·∫´n:</strong> M·ªói d√≤ng m·ªôt t·ª´. ƒê·ªãnh d·∫°ng: 
                <br><code>T·ª´ v·ª±ng | Nghƒ©a | Tag (T√πy ch·ªçn)</code>
                <br>V√≠ d·ª•:<br>
                <i>Apple | Qu·∫£ t√°o | Fruit<br>
                Run | Ch·∫°y b·ªô</i> (Kh√¥ng c√≥ tag)
            </div>
            <div class="form-group">
                <label>Tag m·∫∑c ƒë·ªãnh (n·∫øu kh√¥ng nh·∫≠p trong d√≤ng)</label>
                <input type="text" id="bulk-default-tag" placeholder="VD: NewWords" style="width: 50%;">
            </div>
            <textarea id="bulk-textarea" rows="8" placeholder="Paste danh s√°ch t·ª´ v√†o ƒë√¢y..."></textarea>
            <div id="bulk-status" style="font-size: 0.9rem; font-weight: bold; color: var(--text-main);"></div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="document.getElementById('bulk-modal').style.display='none'">ƒê√≥ng</button>
            <button class="btn-submit" onclick="processBulkImport()" style="background: #9b59b6;">B·∫Øt ƒë·∫ßu Import</button>
        </div>
    </div>
</div>

<div id="edit-modal" class="modal-overlay">
    <div class="modal-content" style="background: var(--bg-card); padding: 25px; border-radius: 10px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto;">
        <h3 style="margin-top:0; color:#e67e22">Ch·ªânh s·ª≠a t·ª´ v·ª±ng</h3>
        
        <input type="text" id="e-vocab" placeholder="T·ª´ v·ª±ng">
        <input type="text" id="e-tag" placeholder="Ch·ªß ƒë·ªÅ (Tag)">
        <input type="text" id="e-ipa" placeholder="IPA">
        <input type="text" id="e-meaning" placeholder="Nghƒ©a">
        <input type="text" id="e-example" placeholder="V√≠ d·ª•">
        <input type="text" id="e-trans" placeholder="D·ªãch v√≠ d·ª•">
        <input type="text" id="e-syn" placeholder="ƒê·ªìng nghƒ©a">
        <input type="text" id="e-ant" placeholder="Tr√°i nghƒ©a">
        <input type="text" id="e-image" placeholder="Link ·∫£nh">
        
        <button onclick="submitEditWord()" id="btn-edit-save" style="background: #e67e22; color: white;">L∆∞u thay ƒë·ªïi</button>
        <button class="close-btn" onclick="document.getElementById('edit-modal').style.display='none'" style="background: var(--danger); color: white; margin-top: 10px;">H·ªßy</button>
    </div>
</div>

<script>
    // --- C·∫§U H√åNH API ---
    const API_URL = "https://script.google.com/macros/s/AKfycbx7JYoblB3rG1um8ZsOR6yWJPH1k01w32R76Ft4BpLtlzne4cChcz5e06uwKSN53v9L5Q/exec";

    // --- BI·∫æN TO√ÄN C·ª§C ---
    let allVocabularyData = []; // Ch·ª©a t·∫•t c·∫£ d·ªØ li·ªáu g·ªëc
    let currentSessionWords = []; // Ch·ª©a danh s√°ch ƒëang h·ªçc (ƒë√£ l·ªçc)
    let currentIndex = 0;
    let currentWord = null;
    let editingWord = null;
    let existingWordsSet = new Set(); 

    window.onload = function() {
        loadData();
    };

    // 1. T·∫£i v√† x·ª≠ l√Ω d·ªØ li·ªáu
    function loadData() {
        document.getElementById('loading').style.display = 'block';
        fetch(API_URL) 
            .then(res => res.json())
            .then(data => {
                allVocabularyData = data;
                
                // T·∫°o Set ƒë·ªÉ check tr√πng
                existingWordsSet = new Set(data.map(w => {
                    const word = w.Vocabulary ? w.Vocabulary : w; 
                    return String(word).toLowerCase().trim();
                }));

                // Kh·ªüi t·∫°o danh s√°ch Tags cho Filter
                initTagSystem(allVocabularyData);

                // M·∫∑c ƒë·ªãnh load t·∫•t c·∫£ t·ª´ ƒë·ªÉ h·ªçc (ho·∫∑c c√≥ th·ªÉ l·ªçc ng√†y t·∫°i ƒë√¢y)
                currentSessionWords = allVocabularyData.sort(() => Math.random() - 0.5);
                
                document.getElementById('loading').style.display = 'none';
                
                if (currentSessionWords.length === 0) {
                    document.getElementById('done-msg').style.display = 'block';
                } else {
                    displayNextWord();
                }
            })
            .catch(e => {
                document.getElementById('loading').innerText = "L·ªói k·∫øt n·ªëi!";
                console.error(e);
            });
    }

    // --- H·ªÜ TH·ªêNG TAG (NEW) ---
    function initTagSystem(data) {
        // L·∫•y danh s√°ch Tag duy nh·∫•t
        const tags = new Set();
        data.forEach(w => {
            if(w.Tag) tags.add(w.Tag.trim());
        });

        // ƒê·ªï v√†o Dropdown Filter
        const filterSelect = document.getElementById('tag-filter');
        filterSelect.innerHTML = '<option value="all">üìö T·∫•t c·∫£</option>';
        tags.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            opt.innerText = `üè∑Ô∏è ${t}`;
            filterSelect.appendChild(opt);
        });

        // ƒê·ªï v√†o Datalist Suggestion (khi th√™m m·ªõi)
        const dataList = document.getElementById('tag-suggestions');
        dataList.innerHTML = '';
        tags.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            dataList.appendChild(opt);
        });
    }

    // H√†m L·ªçc khi ch·ªçn Dropdown
    function applyFilter() {
        const selectedTag = document.getElementById('tag-filter').value;
        document.getElementById('study-area').style.display = 'none';
        document.getElementById('feedback-area').style.display = 'none';
        document.getElementById('done-msg').style.display = 'none';
        
        // Reset phi√™n h·ªçc
        currentIndex = 0;

        if (selectedTag === 'all') {
            currentSessionWords = allVocabularyData.sort(() => Math.random() - 0.5);
        } else {
            // L·ªçc c√°c t·ª´ c√≥ Tag tr√πng kh·ªõp
            currentSessionWords = allVocabularyData.filter(w => w.Tag && w.Tag.trim() === selectedTag).sort(() => Math.random() - 0.5);
        }

        if (currentSessionWords.length === 0) {
            document.getElementById('done-msg').querySelector('p').innerText = `Kh√¥ng c√≥ t·ª´ n√†o thu·ªôc ch·ªß ƒë·ªÅ "${selectedTag}"`;
            document.getElementById('done-msg').style.display = 'block';
        } else {
            displayNextWord();
        }
    }


    // --- LOGIC H·ªåC T·∫¨P (CLOZE) ---
    function displayNextWord() {
        if (currentIndex >= currentSessionWords.length) {
            document.getElementById('study-area').style.display = 'none';
            document.getElementById('feedback-area').style.display = 'none';
            document.getElementById('done-msg').style.display = 'block';
            return;
        }
        currentWord = currentSessionWords[currentIndex];
        document.getElementById('progress-text').innerText = `${currentIndex + 1} / ${currentSessionWords.length}`;
        document.getElementById('study-area').style.display = 'block';
        document.getElementById('feedback-area').style.display = 'none';

        const container = document.getElementById('cloze-container');
        container.innerHTML = "";
        
        let vocab = currentWord.Vocabulary;
        let validIndices = [];
        for (let i = 0; i < vocab.length; i++) {
            if (/[a-zA-Z]/.test(vocab[i])) validIndices.push(i);
        }
        let hiddenCharIndex = validIndices.length > 0 ? validIndices[Math.floor(Math.random() * validIndices.length)] : 0;
        let correctChar = vocab[hiddenCharIndex].toLowerCase();

        for (let i = 0; i < vocab.length; i++) {
            if (i === hiddenCharIndex) {
                let input = document.createElement("input");
                input.className = "cloze-input";
                input.maxLength = 1;
                input.id = "cloze-box";
                input.autocomplete = "off";
                input.oninput = (e) => {
                     if (e.target.value.toLowerCase() === correctChar) {
                        e.target.classList.add("correct");
                        e.target.disabled = true;
                        setTimeout(() => showFeedback(currentWord, true), 500); 
                    } else if (e.target.value.length > 0) {
                        e.target.classList.add("wrong");
                        setTimeout(() => { e.target.classList.remove("wrong"); e.target.value = ""; }, 500);
                    }
                };
                container.appendChild(input);
            } else {
                let span = document.createElement("span");
                span.innerText = vocab[i];
                container.appendChild(span);
            }
        }
        setTimeout(() => document.getElementById('cloze-box')?.focus(), 100);
        playAudio(currentWord.Vocabulary);
    }

    function revealAnswer() { showFeedback(currentWord, false); }

    function showFeedback(wordObj, isCorrect) {
        document.getElementById('search-results-box').style.display = 'none';
        document.getElementById('study-area').style.display = 'none';
        document.getElementById('feedback-area').style.display = 'block';
        
        // Hi·ªÉn th·ªã Badge Tag
        const badge = document.getElementById('a-tag-badge');
        if (wordObj.Tag) {
            badge.innerHTML = `<span class="tag-badge">${wordObj.Tag}</span>`;
            badge.style.display = 'block';
        } else {
            badge.style.display = 'none';
        }

        document.getElementById('a-vocab').innerText = wordObj.Vocabulary;
        document.getElementById('a-ipa').innerText = wordObj.IPA ? `/${wordObj.IPA}/` : "";
        document.getElementById('a-meaning').innerText = wordObj.Meaning;
        
        const imgEl = document.getElementById('a-image');
        if (wordObj.Image) {
            imgEl.src = wordObj.Image; imgEl.style.display = "block";
        } else { imgEl.style.display = "none"; }

        const exBox = document.getElementById('a-example');
        if (wordObj.Example) {
            exBox.parentElement.style.display = "block";
            exBox.innerHTML = `${wordObj.Example} <button onclick="playAudio('${wordObj.Example.replace(/'/g, "\\'")}')">üîä</button>`;
        } else { exBox.parentElement.style.display = "none"; }
        
        document.getElementById('a-trans').innerText = wordObj.ExampleTrans || "";
        
        const createChips = (str, type) => {
            if (!str) return "";
            const chipsHtml = str.split(',').map(s => `<span class="chip ${type}">${s.trim()}</span>`).join('');
            return `<div class="voc-group"><span class="voc-label">${type.includes('syn')?'ƒê·ªìng nghƒ©a':'Tr√°i nghƒ©a'}</span><div class="chip-container">${chipsHtml}</div></div>`;
        };
        document.getElementById('syn-ant-area').innerHTML = createChips(wordObj.Synonyms, 'chip-syn') + createChips(wordObj.Antonyms, 'chip-ant');

        const btnGroup = document.querySelector('.btn-group');
        const status = document.getElementById('result-status');

        if (wordObj === currentWord) {
            btnGroup.style.display = 'flex';
            if(isCorrect) {
                status.innerText = "CH√çNH X√ÅC!"; status.style.color = "var(--success)";
            } else {
                status.innerText = "ƒê√ÅP √ÅN: " + wordObj.Vocabulary; status.style.color = "var(--danger)";
            }
        } else {
            btnGroup.style.display = 'none';
            status.innerText = "Ch·∫ø ƒë·ªô xem t·ª´ ƒëi·ªÉn"; status.style.color = "var(--primary)";
        }
    }

    function rateWord(rating) {
        if (!currentWord) return;
        fetch(API_URL, {
            method: "POST", mode: "no-cors", headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                action: "update",
                rowIndex: currentWord.rowIndex,
                rating: rating,
                currentInterval: currentWord.Interval
            })
        });
        currentIndex++;
        displayNextWord();
    }

    // --- T√åM KI·∫æM ---
    const searchInput = document.getElementById('main-search');
    const searchBox = document.getElementById('search-results-box');

    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        if (query.length < 1) { searchBox.style.display = 'none'; return; }

        const results = allVocabularyData.filter(item => 
            item.Vocabulary && item.Vocabulary.toLowerCase().includes(query)
        ).slice(0, 10);

        if (results.length > 0) {
            searchBox.innerHTML = results.map(item => `
                <div class="search-item" onclick="viewSearchedWord('${item.Vocabulary}')">
                    <div>
                        <strong>${item.Vocabulary}</strong>
                        ${item.Tag ? `<span style="font-size:0.7em; color:var(--primary); margin-left:5px">[${item.Tag}]</span>` : ''}
                    </div>
                    <small>${item.Meaning}</small>
                </div>
            `).join('');
            searchBox.style.display = 'block';
        } else {
            searchBox.innerHTML = '<div style="padding:10px; color:#999">Kh√¥ng t√¨m th·∫•y</div>';
            searchBox.style.display = 'block';
        }
    });

    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchBox.contains(e.target)) {
            searchBox.style.display = 'none';
        }
    });

    function viewSearchedWord(vocab) {
        const wordObj = allVocabularyData.find(w => w.Vocabulary === vocab);
        if (wordObj) {
            showFeedback(wordObj, true); 
            searchInput.value = "";
            searchBox.style.display = 'none';
        }
    }

    // --- BULK IMPORT (WITH TAG SUPPORT) ---
    function openBulkModal() {
        document.getElementById('add-modal').style.display = 'none';
        document.getElementById('bulk-modal').style.display = 'flex';
    }

    async function processBulkImport() {
        const text = document.getElementById('bulk-textarea').value;
        const defaultTag = document.getElementById('bulk-default-tag').value.trim();
        
        if (!text.trim()) return alert("Vui l√≤ng nh·∫≠p danh s√°ch t·ª´!");

        const lines = text.split('\n');
        const btn = document.querySelector('#bulk-modal .btn-submit');
        const statusDiv = document.getElementById('bulk-status');
        
        btn.disabled = true;
        let count = 0; let errors = 0;

        for (let line of lines) {
            if (!line.trim()) continue;
            
            // Format: Vocab | Meaning | Tag
            const parts = line.split('|').map(p => p.trim());
            const vocab = parts[0];
            const meaning = parts[1];
            // N·∫øu d√≤ng c√≥ tag th√¨ l·∫•y, kh√¥ng th√¨ d√πng default tag
            const tag = parts[2] || defaultTag;

            if (!vocab || !meaning) { errors++; continue; }
            if (existingWordsSet.has(vocab.toLowerCase())) { statusDiv.innerText = `B·ªè qua tr√πng: ${vocab}...`; continue; }

            statusDiv.innerText = `ƒêang l∆∞u: ${vocab}... (${count + 1})`;

            try {
                 await fetch(API_URL, {
                    method: "POST", mode: "no-cors", headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        action: "add",
                        Vocabulary: vocab, Meaning: meaning, Tag: tag, // Send Tag
                        IPA: "", Example: "", ExampleTrans: "", Synonyms: "", Antonyms: "", Image: ""
                    })
                });
                
                existingWordsSet.add(vocab.toLowerCase());
                allVocabularyData.push({ Vocabulary: vocab, Meaning: meaning, Tag: tag });
                count++;
                await new Promise(r => setTimeout(r, 800));

            } catch (e) { console.error(e); errors++; }
        }

        statusDiv.innerText = `‚úÖ Ho√†n t·∫•t! ƒê√£ th√™m ${count} t·ª´.`;
        btn.disabled = false; btn.innerText = "Import xong";
        document.getElementById('bulk-textarea').value = "";
        setTimeout(() => location.reload(), 2000); 
    }

    // --- ADD NEW WORD (WITH TAG) ---
    function openAddModal() { document.getElementById('add-modal').style.display = 'flex'; document.getElementById('f-vocab').focus(); }
    function closeAddModal() { document.getElementById('add-modal').style.display = 'none'; }

    let typingTimer; const inputVocab = document.getElementById('f-vocab');
    inputVocab.addEventListener('input', () => {
        const val = inputVocab.value.trim().toLowerCase();
        const warning = document.getElementById('duplicate-warning'); 
        const btnSave = document.getElementById('btn-save');
        if (existingWordsSet.has(val)) {
            if(warning) warning.style.display = 'block'; 
            if(btnSave) { btnSave.disabled = true; btnSave.style.opacity = "0.5"; btnSave.innerText = "T·ª´ n√†y ƒë√£ c√≥!"; }
            clearTimeout(typingTimer); return; 
        } else {
            if(warning) warning.style.display = 'none';
            if(btnSave) { btnSave.disabled = false; btnSave.style.opacity = "1"; btnSave.innerText = "L∆∞u th·∫ª n√†y"; }
        }
        clearTimeout(typingTimer);
        if (val.length > 1) { typingTimer = setTimeout(autoFillWord, 800); }
    });

    function showLoading(isLoading) {
        const btn = document.getElementById('btn-lookup');
        btn.innerText = isLoading ? "‚è≥" : "üîç"; btn.disabled = isLoading;
    }

    async function autoFillWord() {
        const word = document.getElementById('f-vocab').value.trim();
        if (!word) return;
        showLoading(true);
        try {
            let dataDict = null;
            try {
                const resDict = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
                if (resDict.ok) { const json = await resDict.json(); dataDict = json[0]; }
            } catch (e) {}
            const translate = async (text) => {
                if(!text) return "";
                try {
                    const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=vi&dt=t&q=${encodeURIComponent(text)}`);
                    const json = await res.json();
                    return json[0].map(x => x[0]).join("");
                } catch (e) { return ""; }
            };

            let ipa = "", example = "", synonyms = "", antonyms = "";
            if (dataDict) {
                ipa = dataDict.phonetic || (dataDict.phonetics.find(p => p.text)?.text) || "";
                for (let m of dataDict.meanings) {
                    if(!synonyms && m.synonyms?.length) synonyms = m.synonyms.slice(0,5).join(", ");
                    if(!antonyms && m.antonyms?.length) antonyms = m.antonyms.slice(0,5).join(", ");
                    for (let d of m.definitions) { if (d.example) { example = d.example; break; } }
                    if (example) break; 
                }
            }
            document.getElementById('f-ipa').value = ipa;
            document.getElementById('f-meaning').value = await translate(word);
            document.getElementById('f-example').value = example;
            document.getElementById('f-trans').value = await translate(example);
            document.getElementById('f-syn').value = synonyms;
            document.getElementById('f-ant').value = antonyms;
            const imgUrl = `https://loremflickr.com/400/300/${encodeURIComponent(word)}`;
            document.getElementById('f-image').value = imgUrl;
            document.getElementById('preview-img').src = imgUrl; document.getElementById('preview-img').style.display = "block";
        } catch (err) { console.error(err); } finally { showLoading(false); }
    }

    function submitNewWord() {
        const vocab = document.getElementById('f-vocab').value;
        const meaning = document.getElementById('f-meaning').value;
        const tag = document.getElementById('f-tag').value; // Get Tag

        if(!vocab || !meaning) return alert("C·∫ßn nh·∫≠p T·ª´ v·ª±ng v√† Nghƒ©a!");
        const btn = document.getElementById('btn-save');
        btn.innerText = "ƒêang l∆∞u..."; btn.disabled = true;

        const newWord = {
            action: "add",
            Vocabulary: vocab, IPA: document.getElementById('f-ipa').value,
            Meaning: meaning, Tag: tag, // Send Tag
            Example: document.getElementById('f-example').value, ExampleTrans: document.getElementById('f-trans').value,
            Synonyms: document.getElementById('f-syn').value, Antonyms: document.getElementById('f-ant').value,
            Image: document.getElementById('f-image').value
        };

        fetch(API_URL, {
            method: "POST", mode: "no-cors", headers: {"Content-Type": "application/json"},
            body: JSON.stringify(newWord)
        }).then(() => {
            alert("ƒê√£ th√™m th√†nh c√¥ng!");
            allVocabularyData.push(newWord); existingWordsSet.add(vocab.toLowerCase().trim());
            initTagSystem(allVocabularyData); // Refresh tags
            closeAddModal();
            document.querySelectorAll('#add-modal input, #add-modal textarea').forEach(i => i.value = '');
            document.getElementById('preview-img').style.display = 'none';
            btn.innerText = "L∆∞u th·∫ª n√†y"; btn.disabled = false;
        }).catch(e => { alert("L·ªói l∆∞u: " + e); btn.innerText = "L∆∞u th·∫ª n√†y"; btn.disabled = false; });
    }

    // --- EDIT WORD (WITH TAG) ---
    function openEditModalFromView() {
        const currentVocab = document.getElementById('a-vocab').innerText;
        const wordObj = allVocabularyData.find(w => w.Vocabulary === currentVocab);
        
        if (wordObj) {
            editingWord = wordObj;
            document.getElementById('e-vocab').value = wordObj.Vocabulary;
            document.getElementById('e-tag').value = wordObj.Tag || ""; // Load tag
            document.getElementById('e-ipa').value = wordObj.IPA;
            document.getElementById('e-meaning').value = wordObj.Meaning;
            document.getElementById('e-example').value = wordObj.Example;
            document.getElementById('e-trans').value = wordObj.ExampleTrans;
            document.getElementById('e-syn').value = wordObj.Synonyms;
            document.getElementById('e-ant').value = wordObj.Antonyms;
            document.getElementById('e-image').value = wordObj.Image;
            document.getElementById('edit-modal').style.display = 'flex';
        }
    }

    function submitEditWord() {
        if (!editingWord) return;
        const btn = document.getElementById('btn-edit-save');
        btn.innerText = "ƒêang l∆∞u..."; btn.disabled = true;

        const updatedData = {
            action: "edit_content",
            rowIndex: editingWord.rowIndex,
            Vocabulary: document.getElementById('e-vocab').value,
            Tag: document.getElementById('e-tag').value, // Send updated tag
            IPA: document.getElementById('e-ipa').value,
            Meaning: document.getElementById('e-meaning').value,
            Example: document.getElementById('e-example').value,
            ExampleTrans: document.getElementById('e-trans').value,
            Synonyms: document.getElementById('e-syn').value,
            Antonyms: document.getElementById('e-ant').value,
            Image: document.getElementById('e-image').value
        };

        fetch(API_URL, {
            method: "POST", mode: "no-cors", headers: {"Content-Type": "application/json"},
            body: JSON.stringify(updatedData)
        }).then(() => {
            alert("ƒê√£ c·∫≠p nh·∫≠t!");
            document.getElementById('edit-modal').style.display = 'none';
            btn.innerText = "L∆∞u thay ƒë·ªïi"; btn.disabled = false;
            
            Object.assign(editingWord, updatedData); 
            initTagSystem(allVocabularyData); // Refresh tag list if new tag added
            showFeedback(editingWord, true); 
        }).catch(e => { alert("L·ªói: " + e); btn.innerText = "L∆∞u thay ƒë·ªïi"; btn.disabled = false; });
    }

    // --- UTILS: AUDIO & VOICE ---
    function playAudio(text) {
        if (!text) return;
        new Audio(`https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=en&q=${encodeURIComponent(text)}`).play().catch(e=>{});
    }
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition; 
    if (SpeechRecognition) {
        recognition = new SpeechRecognition(); recognition.lang = 'en-US'; recognition.interimResults = false; 
        recognition.onstart = () => { document.getElementById('btn-mic').classList.add('listening'); document.getElementById('mic-status').innerText = "ƒêang nghe..."; };
        recognition.onend = () => { document.getElementById('btn-mic')?.classList.remove('listening'); document.getElementById('mic-status').innerText = ""; };
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript.toLowerCase().trim();
            document.getElementById('voice-box').style.display = 'block'; document.getElementById('voice-result-text').innerText = transcript;
            const cleanT = transcript.replace(/[^a-z0-9]/g, ""); const cleanC = currentWord.Vocabulary.toLowerCase().replace(/[^a-z0-9]/g, "");
            if (cleanT === cleanC && cleanC.length > 0) {
                document.getElementById('mic-status').innerText = "Ch√≠nh x√°c! üéâ";
                document.querySelectorAll('.cloze-input').forEach((input, i) => { input.value = currentWord.Vocabulary[i]; input.classList.add('correct'); });
                setTimeout(() => showFeedback(currentWord, true), 1000);
            }
        };
    } else { document.getElementById('btn-mic').style.display = 'none'; }
    function startListening() { if (!recognition) return alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£."); try { recognition.start(); } catch (e) { recognition.stop(); } }

    // --- DARK MODE ---
    if (localStorage.getItem('theme') === 'dark') { document.body.classList.add('dark-mode'); document.getElementById('btn-theme').innerText = '‚òÄÔ∏è'; }
    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        document.getElementById('btn-theme').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
    }
</script>

</body>
</html>
